name: Build luci-app-twofa

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # 官方提供 SDK 的架构
          - target: x86/64
            sdk_url: https://downloads.openwrt.org/releases/24.10.4/targets/x86/64/openwrt-sdk-24.10.4-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst

          - target: aarch64_generic
            sdk_url: https://downloads.openwrt.org/releases/24.10.4/targets/rockchip/armv8/openwrt-sdk-24.10.4-rockchip-armv8_gcc-13.3.0_musl.Linux-x86_64.tar.zst

          # 官方无 SDK，使用 ImmortalWRT（23.05.3 兼容）
          - target: aarch64_cortex-a53
            sdk_url: https://downloads.openwrt.org/releases/24.10.4/targets/mvebu/cortexa53/openwrt-sdk-24.10.4-mvebu-cortexa53_gcc-13.3.0_musl.Linux-x86_64.tar.zst

          - target: aarch64_cortex-a72
            sdk_url: https://downloads.openwrt.org/releases/24.10.4/targets/mvebu/cortexa72/openwrt-sdk-24.10.4-mvebu-cortexa72_gcc-13.3.0_musl.Linux-x86_64.tar.zst
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt update && sudo apt install -y build-essential wget tar

      - name: Download and extract SDK
        run: |
          mkdir -p ~/sdk
          wget -O sdk.tar.xz "${{ matrix.sdk_url }}"
          tar -xf sdk.tar.xz -C ~/sdk --strip-components=1

      - name: Copy plugin
        run: cp -r . ~/sdk/package/luci-app-twofa

      - name: Build
        working-directory: ~/sdk
        run: |
          echo "CONFIG_PACKAGE_luci-app-twofa=y" >> .config
          make defconfig
          make package/luci-app-twofa/compile V=s

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-twofa-${{ matrix.target }}
          path: ~/sdk/bin/packages/**/luci/luci-app-twofa_*.ipk
