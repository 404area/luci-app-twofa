#
# Copyright (c) 2022-2025 luci-app-twofa
# Description: Auto compile luci-app-twofa for OpenWrt 24.10
#
name: "Auto compile luci-app-twofa"

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  check_version:
    name: Check for updates
    runs-on: ubuntu-latest
    outputs:
      has_update: ${{ steps.check.outputs.has_update }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - id: check
        run: |
          echo "has_update=true" >> $GITHUB_OUTPUT

  build_packages:
    name: Build [${{ matrix.target.platform }}]
    needs: check_version
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          # 以下链接适配最新的 24.10.x 稳定版
          - platform: "x86_64"
            sdk_url: "https://downloads.openwrt.org/releases/24.10.0/targets/x86/64/openwrt-sdk-24.10.0-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          - platform: "aarch64_generic"
            sdk_url: "https://downloads.openwrt.org/releases/24.10.0/targets/rockchip/armv8/openwrt-sdk-24.10.0-rockchip-armv8_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          - platform: "mips_24kc"
            sdk_url: "https://downloads.openwrt.org/releases/24.10.0/targets/ath79/generic/openwrt-sdk-24.10.0-ath79-generic_gcc-13.3.0_musl.Linux-x86_64.tar.zst"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialization environment
        run: |
          sudo -E apt-get -qq update
          # 增加 zstd 支持，24.10 SDK 必须
          sudo -E apt-get -qq install build-essential libncurses-dev gawk git gettext libssl-dev xsltproc zip zlib1g-dev file zstd rsync

      - name: Download OpenWrt SDK
        run: |
          wget ${{ matrix.target.sdk_url }}
          file_name=$(basename ${{ matrix.target.sdk_url }})
          mkdir sdk
          # 24.10 使用 zstd 压缩，需要特殊解压参数
          tar --zstd -xf $file_name -C ./sdk --strip-components=1
          cd sdk
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Copy luci-app-twofa to SDK
        run: |
          # 关键：将当前仓库代码强制覆盖进 SDK 的 package 目录
          mkdir -p $GITHUB_WORKSPACE/sdk/package/luci-app-twofa
          rsync -av --exclude='sdk' . $GITHUB_WORKSPACE/sdk/package/luci-app-twofa/

      - name: Configure build
        run: |
          cd $GITHUB_WORKSPACE/sdk
          # 强制选中我们的包
          echo "CONFIG_PACKAGE_luci-app-twofa=m" > .config
          # 处理 24.10 依赖：确保 qrencode 和 libnixio 可用
          make defconfig

      - name: Compile luci-app-twofa
        id: compile
        run: |
          cd $GITHUB_WORKSPACE/sdk
          # 编译逻辑
          make package/luci-app-twofa/compile -j$(nproc) V=s
          
          # 24.10 的目录结构可能多了一层，使用 find 定位
          mkdir -p $GITHUB_WORKSPACE/release
          find bin/packages -name "luci-app-twofa*.ipk" -exec cp {} $GITHUB_WORKSPACE/release/ \;
          
          if [ "$(ls -A $GITHUB_WORKSPACE/release)" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "编译失败：未找到生成的 ipk"
            exit 1
          fi

      - name: Upload artifacts
        if: steps.compile.outputs.status == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-twofa-${{ matrix.target.platform }}
          path: ${{ github.workspace }}/release/*.ipk

  release:
    name: Create Release
    needs: build_packages
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          name: "Release v${{ github.run_number }} for 24.10"
          files: ./artifacts/**/*.ipk
          draft: false
          prerelease: false
