<%
-- 这是一个嵌入到全局页面的钩子
local sys = require "luci.sys"
local uci = require "luci.model.uci".cursor()
local auth = require "luci.twofa.auth"
local dsp = require "luci.dispatcher"

-- 获取当前请求路径
local path = dsp.context.requestpath
local path_str = table.concat(path, "/")

-- 白名单路径：登录页、静态资源、API接口(如果是两步验证自己的API)
if path_str == "admin/system/twofa/verify" or
   path_str == "admin/system/twofa/status" or
   path_str == "admin/logout" or
   path_str:match("^luci%-static/") then
    return
end

-- 检查是否启用且未验证
local sid = dsp.context.authsession
if sid and auth.is_enabled() and not auth.is_verified(sid) then
    -- 如果是普通的 GET 请求，我们可以重定向到一个专门的验证页
    -- 但为了保持当前页面上下文，我们通常还是依赖 JS 弹窗
    -- 不过，为了后端安全，我们可以强制中断敏感操作

    -- 如果是 POST 请求（修改配置），直接拦截
    if dsp.context.request.REQUEST_METHOD == "POST" then
        luci.http.status(403, "Forbidden")
        luci.http.write("Two-Factor Authentication Required")
        luci.http.close()
        return
    end
end
%>
<script type="text/javascript">
// 这里可以注入更底层的 JS 检查
</script>
